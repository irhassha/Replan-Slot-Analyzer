<!DOCTYPE html>
<html class="scroll-smooth" lang="id">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Replan-Slot Analyzer | Smart Stacking</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&amp;family=JetBrains+Mono:wght@400;500&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#10b981", // Emerald 500
                        "primary-dark": "#059669",
                        "background-light": "#f8fafc",
                        "background-dark": "#0f172a",
                        surface: "#ffffff",
                        "surface-dark": "#1e293b",
                    },
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', "sans-serif"],
                        mono: ['"JetBrains Mono"', "monospace"],
                    },
                },
            },
        };
    </script>
    
    <style>
        /* Custom Utilities */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .dark .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .slot-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .slot-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .filter-btn-active {
            background-color: #10b981;
            color: white;
            border-color: #10b981;
        }
        .filter-btn-inactive {
            background-color: white;
            color: #64748b;
            border-color: #e2e8f0;
        }
        .dark .filter-btn-inactive {
            background-color: #1e293b;
            color: #94a3b8;
            border-color: #334155;
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark text-slate-800 dark:text-slate-200 antialiased min-h-screen flex flex-col transition-colors duration-300">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 glass-panel border-b border-slate-200 dark:border-slate-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined text-primary text-3xl">view_column</span>
                    <div>
                        <h1 class="font-bold text-lg tracking-tight leading-tight">Replan-Slot Analyzer</h1>
                        <p class="text-xs text-slate-500 dark:text-slate-400 font-medium">Smart Stacking Solutions</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-4">
                    <!-- File Upload Button -->
                    <div class="relative group">
                        <input type="file" id="excelFile" accept=".xlsx" class="hidden" onchange="handleFile(event)">
                        <button id="uploadBtn" onclick="document.getElementById('excelFile').click()" 
                            class="flex items-center gap-2 px-4 py-2 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg text-sm font-medium transition-all border border-slate-200 dark:border-slate-700">
                            <span id="uploadIcon" class="material-symbols-outlined text-base">upload_file</span>
                            <span id="uploadLabel">Upload UnitListAll.xlsx</span>
                        </button>
                        <div id="fileStatus" class="absolute right-0 top-full mt-2 text-xs text-right whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity text-slate-500">
                            No file loaded
                        </div>
                    </div>

                    <!-- Theme Toggle -->
                    <button onclick="document.documentElement.classList.toggle('dark')" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors">
                        <span class="material-symbols-outlined dark:hidden">dark_mode</span>
                        <span class="material-symbols-outlined hidden dark:block text-yellow-400">light_mode</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full space-y-8">
        
        <!-- TOP: DATA VISUALIZATION (Cleaned Up) -->
        <div class="bg-surface dark:bg-surface-dark rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-6 animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-sm font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 flex items-center gap-2">
                    <span class="material-symbols-outlined text-lg">compare_arrows</span> Comparison Data
                </h2>
                <span class="text-xs text-slate-400">Key fields extracted from input</span>
            </div>
            <div class="table-wrapper overflow-x-auto rounded-lg border border-slate-200 dark:border-slate-700">
                <table id="previewTable" class="w-full text-left text-xs">
                    <thead class="bg-slate-50 dark:bg-slate-800/50">
                        <tr id="pHead">
                            <th class="px-4 py-3 font-semibold text-slate-500">Key</th>
                            <th class="px-4 py-3 font-semibold text-slate-500">Value</th>
                        </tr>
                    </thead>
                    <tbody id="pBody">
                        <tr><td colspan="2" class="text-center italic p-6 text-slate-400">Waiting for data paste...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- LEFT COLUMN: INPUT -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- Input Card -->
                <div class="bg-surface dark:bg-surface-dark rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-6 animate-fade-in" style="animation-delay: 0.1s;">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-sm font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">edit_note</span> Data Input (TOS)
                        </h2>
                        <button onclick="clearInput()" class="text-xs font-medium text-slate-400 hover:text-primary transition-colors">Clear</button>
                    </div>
                    
                    <div class="relative">
                        <textarea id="rawInput" 
                            class="w-full h-40 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-4 text-xs font-mono focus:ring-2 focus:ring-primary focus:border-primary transition-all resize-none"
                            placeholder="Paste header and data row here..." oninput="analyze()"></textarea>
                        <div class="absolute bottom-3 right-3">
                            <span class="flex h-2 w-2 relative">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-primary"></span>
                            </span>
                        </div>
                    </div>

                    <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-900/50">
                        <div class="flex gap-2">
                            <span class="material-symbols-outlined text-blue-500 text-lg">info</span>
                            <div class="text-xs text-blue-800 dark:text-blue-200 leading-relaxed">
                                <strong>Logic:</strong> System finds matches in Excel, detects highest occupied tier in a stack, and suggests next available tiers (Max 5).
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Card -->
                <div class="bg-surface dark:bg-surface-dark rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-6 animate-fade-in" style="animation-delay: 0.2s;">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-sm font-bold uppercase tracking-wider text-slate-500 dark:text-slate-400 flex items-center gap-2">
                            <span class="material-symbols-outlined text-lg">history</span> Selection History
                        </h2>
                        <button onclick="clearHistory()" class="text-xs font-medium text-red-400 hover:text-red-500 transition-colors">Reset</button>
                    </div>

                    <div class="overflow-hidden rounded-xl border border-slate-200 dark:border-slate-700">
                        <div class="max-h-[400px] overflow-y-auto">
                            <table class="w-full text-left text-xs">
                                <thead class="bg-slate-50 dark:bg-slate-800 sticky top-0 z-10">
                                    <tr>
                                        <th class="px-4 py-3 font-semibold text-slate-600 dark:text-slate-300">Time</th>
                                        <th class="px-4 py-3 font-semibold text-slate-600 dark:text-slate-300">Slot</th>
                                        <th class="px-4 py-3 font-semibold text-slate-600 dark:text-slate-300">Info</th>
                                    </tr>
                                </thead>
                                <tbody id="historyBody" class="divide-y divide-slate-100 dark:divide-slate-800">
                                    <tr>
                                        <td colspan="3" class="px-4 py-8 text-center text-slate-400 italic">No slots selected yet.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>

            <!-- RIGHT COLUMN: RESULTS -->
            <div class="lg:col-span-8 space-y-6">
                <div class="bg-surface dark:bg-surface-dark rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800 p-6 min-h-[600px] animate-fade-in" style="animation-delay: 0.3s;">
                    
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-end mb-6 border-b border-slate-100 dark:border-slate-800 pb-4 gap-4">
                        <div>
                            <h2 class="text-xl font-bold text-slate-800 dark:text-white mb-1">Recommended Slots</h2>
                            <p class="text-sm text-slate-500">Grouped by Block â€¢ Filtered by Compatibility</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="px-3 py-1 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 text-xs font-bold border border-emerald-200 dark:border-emerald-800">
                                TIER &le; 5
                            </span>
                        </div>
                    </div>

                    <!-- NEW: BLOCK FILTERS -->
                    <div id="filterContainer" class="flex flex-wrap gap-2 mb-6 hidden">
                        <!-- Filters generated by JS -->
                    </div>

                    <!-- Slot Grid Container -->
                    <div id="slotDisplay" class="space-y-8">
                        
                        <!-- Empty State -->
                        <div class="flex flex-col items-center justify-center py-20 text-slate-400">
                            <span class="material-symbols-outlined text-6xl mb-4 text-slate-200 dark:text-slate-700">dns</span>
                            <p class="text-sm">Waiting for data input...</p>
                        </div>

                    </div>

                </div>
            </div>

        </div>

    </main>

    <!-- Footer -->
    <footer class="border-t border-slate-200 dark:border-slate-800 mt-auto bg-white dark:bg-slate-900 py-6">
        <div class="max-w-7xl mx-auto px-4 text-center text-xs text-slate-500">
            &copy; 2026 Replan-Slot Analyzer. Optimized for High Performance Logistics.
        </div>
    </footer>

    <!-- Logic Script -->
    <script>
        // Init GSAP
        gsap.registerPlugin();
        
        const animateItems = () => {
            gsap.from(".animate-fade-in", {
                y: 20,
                opacity: 0,
                duration: 0.6,
                stagger: 0.1,
                ease: "power2.out"
            });
        };
        
        window.addEventListener('load', animateItems);

        // --- CORE LOGIC ---
        let db = [];
        let selectedFullSlotsHistory = []; 
        let currentMatches = [];
        let currentUnit = "";
        let activeBlockFilter = 'ALL'; // Default filter

        function normalize(str) {
            if (str === undefined || str === null) return "";
            return str.toString()
                .replace(/_x000D_/g, '')
                .replace(/[\r\n\t]/g, ' ')
                .replace(/,/g, '.')
                .replace(/\s*-\s*/g, '-') 
                .replace(/\s+/g, ' ')
                .trim()
                .toLowerCase();
        }

        function cleanKey(str) {
            return normalize(str).replace(/[^a-z0-9]/g, '');
        }

        function handleFile(e) {
            const file = e.target.files[0];
            if(!file) return;
            
            const btn = document.getElementById('uploadBtn');
            const btnLabel = document.getElementById('uploadLabel');
            const btnIcon = document.getElementById('uploadIcon');
            const statusEl = document.getElementById('fileStatus');
            
            // Loading State Style
            btnLabel.innerText = "Reading File...";
            btn.className = "flex items-center gap-2 px-4 py-2 bg-yellow-100 text-yellow-700 rounded-lg text-sm font-bold border border-yellow-300 shadow-sm animate-pulse cursor-wait";
            btnIcon.innerText = "hourglass_empty";

            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const data = new Uint8Array(evt.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                    
                    db = json.map(row => {
                        let cleanRow = {};
                        for (let key in row) {
                            let cKey = cleanKey(key);
                            cleanRow[cKey] = normalize(row[key]);
                            if (cKey === 'slotexe') cleanRow['_raw_slot'] = row[key].toString().trim();
                        }
                        return cleanRow;
                    });

                    // Success State Style
                    btnLabel.innerText = "File Loaded";
                    btn.className = "flex items-center gap-2 px-4 py-2 bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300 rounded-lg text-sm font-bold border border-emerald-300 dark:border-emerald-700 shadow-sm transition-all";
                    btnIcon.innerText = "check_circle";

                    statusEl.innerText = `Ready: ${db.length} rows`;
                    statusEl.classList.remove('text-slate-500');
                    statusEl.classList.add('text-primary');
                    
                    // Visual feedback
                    gsap.fromTo(btn, {scale: 0.95}, {scale: 1, duration: 0.3, ease: "back.out(2)"});
                    analyze();
                } catch (err) {
                    btnLabel.innerText = "Error!";
                    btn.className = "flex items-center gap-2 px-4 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-bold border border-red-300";
                    btnIcon.innerText = "error";
                    console.error(err);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function analyze() {
            const text = document.getElementById('rawInput').value.trim();
            if (!text || db.length === 0) {
                renderEmptyState();
                return;
            }

            const lines = text.split(/\r?\n/);
            const headers = lines[0].split('\t').map(h => h.trim());
            const values = lines[1] ? lines[1].split('\t').map(v => v.trim()) : [];

            // --- NEW PREVIEW LOGIC: Only show Key Comparison Fields ---
            const targetKeys = ['Unit', 'Service Out', 'Carrier Out', 'SPOD', 'Unit length', 'Wt. cl.', 'Cont. type', 'Unit height'];
            let previewHeadHtml = "";
            let previewBodyHtml = "";

            // Use grid layout instead of standard table for better readability of comparisons
            let gridContent = "";
            
            targetKeys.forEach(key => {
                const idx = headers.indexOf(key);
                const val = idx !== -1 ? values[idx] : "-";
                
                // Styling for values
                gridContent += `
                    <div class="flex flex-col p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg border border-slate-100 dark:border-slate-700">
                        <span class="text-[10px] uppercase font-bold text-slate-400 mb-1">${key}</span>
                        <span class="text-sm font-mono font-medium text-slate-700 dark:text-slate-200 truncate" title="${val}">${val}</span>
                    </div>
                `;
            });

            // Replace table structure with grid
            document.getElementById('previewTable').parentElement.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    ${gridContent}
                </div>
            `;

            // Core Extraction for Logic
            const findVal = (name) => {
                const cleanName = cleanKey(name);
                const idx = headers.findIndex(h => cleanKey(h) === cleanName);
                return idx !== -1 ? normalize(values[idx]) : "";
            };

            currentUnit = findVal("Unit").toUpperCase();

            const target = {
                svc: findVal("Service Out"),
                carr: findVal("Carrier Out"),
                spod: findVal("SPOD"),
                len: findVal("Unit length"),
                wt: findVal("Wt. cl."),
                type: findVal("Cont. type"),
                height: findVal("Unit height")
            };

            // Filter Excel
            currentMatches = db.filter(item => {
                const matchSvc = item.serviceout === target.svc;
                const matchCarr = item.carrierout === target.carr;
                const matchSpod = item.spod === target.spod;
                const matchLen = item.unitlength === target.len;
                const matchType = item.conttype === target.type;
                const matchHeight = item.unitheight === target.height;
                
                const p1 = parseInt(item.wtcl);
                const p2 = parseInt(target.wt);
                const matchWt = (item.wtcl === target.wt) || (!isNaN(p1) && !isNaN(p2) && p1 === p2);

                return matchSvc && matchCarr && matchSpod && matchLen && matchType && matchHeight && matchWt;
            });

            calculateAvailableSlots();
        }

        function calculateAvailableSlots() {
            const out = document.getElementById('slotDisplay');
            const filterContainer = document.getElementById('filterContainer');
            
            if (currentMatches.length === 0) {
                out.innerHTML = `
                    <div class="p-6 bg-red-50 dark:bg-red-900/20 border border-red-100 dark:border-red-900 rounded-xl text-center">
                        <span class="material-symbols-outlined text-red-500 text-3xl mb-2">error</span>
                        <p class="text-red-700 dark:text-red-300 font-medium">No matching stacks found in Unit List.</p>
                        <p class="text-xs text-red-500 mt-1">Check Service, Carrier, SPOD, and Dimensions.</p>
                    </div>`;
                filterContainer.classList.add('hidden');
                return;
            }

            // Group by Base Slot -> Find Max Occupied
            let stackInfo = {};

            currentMatches.forEach(m => {
                let fullSlotRaw = (m._raw_slot || "").trim();
                if (fullSlotRaw.includes('-')) {
                    let p = fullSlotRaw.split('-');
                    let tier = parseInt(p.pop());
                    let base = p.join('-'); 
                    
                    if (!isNaN(tier)) {
                        if (!stackInfo[base]) stackInfo[base] = 0;
                        if (tier > stackInfo[base]) stackInfo[base] = tier;
                    }
                }
            });

            // Generate Available Tiers & Identify Blocks
            let stacks = []; 
            const usedFullSlots = new Set(selectedFullSlotsHistory.map(h => h.fullSlot.trim()));

            Object.keys(stackInfo).forEach(base => {
                let maxOccupied = stackInfo[base];
                let availableTiers = [];

                for (let t = maxOccupied + 1; t <= 5; t++) {
                    let potentialSlot = `${base}-${t}`;
                    if (!usedFullSlots.has(potentialSlot)) {
                        availableTiers.push({ tier: t, raw: potentialSlot });
                    }
                }

                if (availableTiers.length > 0) {
                    let parts = base.split('-');
                    let blockId = parts.length > 0 ? parts[0] : "Other";

                    stacks.push({
                        base: base,
                        block: blockId,
                        tiers: availableTiers,
                        occupied: maxOccupied
                    });
                }
            });

            if (stacks.length === 0) {
                out.innerHTML = `
                    <div class="p-6 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-100 dark:border-yellow-900 rounded-xl text-center">
                        <span class="material-symbols-outlined text-yellow-500 text-3xl mb-2">layers_clear</span>
                        <p class="text-yellow-700 dark:text-yellow-300 font-medium">All stackable tiers (up to 5) are full or selected.</p>
                    </div>`;
                filterContainer.classList.add('hidden');
                return;
            }

            // --- FILTER LOGIC ---
            // 1. Get unique blocks
            const blocks = [...new Set(stacks.map(s => s.block))].sort();
            
            // 2. Render Filter Buttons
            if (blocks.length > 0) {
                let filterHtml = `
                    <button onclick="setFilter('ALL')" 
                        class="px-3 py-1.5 text-xs font-bold rounded-lg border transition-all ${activeBlockFilter === 'ALL' ? 'filter-btn-active' : 'filter-btn-inactive'}">
                        ALL
                    </button>
                `;
                
                blocks.forEach(b => {
                    filterHtml += `
                        <button onclick="setFilter('${b}')" 
                            class="px-3 py-1.5 text-xs font-bold rounded-lg border transition-all ${activeBlockFilter === b ? 'filter-btn-active' : 'filter-btn-inactive'}">
                            ${b}
                        </button>
                    `;
                });
                
                filterContainer.innerHTML = filterHtml;
                filterContainer.classList.remove('hidden');
            }

            // 3. Apply Filter
            const displayBlocks = activeBlockFilter === 'ALL' ? blocks : blocks.filter(b => b === activeBlockFilter);

            // --- RENDER SLOTS ---
            let html = "";
            
            displayBlocks.forEach(blockName => {
                // Filter stacks for this block
                const blockStacks = stacks.filter(s => s.block === blockName).sort((a,b) => a.base.localeCompare(b.base));
                if (blockStacks.length === 0) return;

                html += `
                    <div class="animate-block-group">
                        <div class="flex items-center gap-2 mb-3 mt-2">
                            <span class="h-2 w-2 rounded-full bg-primary"></span>
                            <h3 class="text-sm font-bold text-slate-700 dark:text-slate-200 uppercase tracking-widest">
                                Block ${blockName}
                            </h3>
                            <span class="text-xs bg-slate-100 dark:bg-slate-800 text-slate-500 px-2 py-0.5 rounded-full border border-slate-200 dark:border-slate-700">
                                ${blockStacks.length} Stacks
                            </span>
                        </div>
                        
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                            ${blockStacks.map(stack => `
                                <div class="slot-card bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-3 flex flex-col gap-2 relative overflow-hidden group">
                                    <div class="absolute top-0 right-0 p-1 opacity-10 group-hover:opacity-20 transition-opacity">
                                        <span class="material-symbols-outlined text-4xl">inventory_2</span>
                                    </div>
                                    
                                    <div class="flex justify-between items-start z-10">
                                        <span class="text-xs font-bold text-slate-700 dark:text-slate-200 tracking-tight font-mono">${stack.base}</span>
                                        <span class="text-[10px] text-slate-400 font-mono bg-slate-100 dark:bg-slate-700 px-1 rounded">Top:${stack.occupied}</span>
                                    </div>
                                    
                                    <div class="flex flex-wrap gap-1 z-10 mt-auto">
                                        ${stack.tiers.map(t => `
                                            <button onclick="selectSlot('${t.raw}')" 
                                                class="flex-1 min-w-[30px] h-7 flex items-center justify-center bg-primary hover:bg-primary-dark text-white text-[10px] font-bold rounded transition-all hover:scale-105 active:scale-95 shadow-sm">
                                                T${t.tier}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="h-px bg-slate-100 dark:bg-slate-800 my-6 w-full last:hidden"></div>
                    </div>
                `;
            });

            out.innerHTML = html;

            // Animate blocks
            gsap.fromTo(".animate-block-group", 
                { y: 20, opacity: 0 },
                { y: 0, opacity: 1, duration: 0.5, stagger: 0.1, ease: "power2.out" }
            );
        }

        function setFilter(filter) {
            activeBlockFilter = filter;
            calculateAvailableSlots();
        }

        function selectSlot(fullSlot) {
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ":" + 
                            now.getMinutes().toString().padStart(2, '0') + ":" + 
                            now.getSeconds().toString().padStart(2, '0');

            const matchInfo = currentMatches[0];
            const info = matchInfo ? `${matchInfo.serviceout.toUpperCase()}<br/><span class="text-[10px] text-slate-400">${matchInfo.carrierout.toUpperCase()}</span>` : "-";

            selectedFullSlotsHistory.unshift({
                time: timeStr,
                unit: currentUnit || "N/A",
                fullSlot: fullSlot.trim(),
                info: info
            });

            calculateAvailableSlots(); 
            updateHistoryTable();
        }

        function updateHistoryTable() {
            const tbody = document.getElementById('historyBody');
            if (selectedFullSlotsHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="px-4 py-8 text-center text-slate-400 italic">No slots selected yet.</td></tr>';
                return;
            }

            tbody.innerHTML = selectedFullSlotsHistory.map((h, i) => `
                <tr class="group hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors ${i === 0 ? 'animate-new-row' : ''}">
                    <td class="px-4 py-3 font-mono text-xs text-slate-500">${h.time}</td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300">
                            ${h.unit}
                        </span>
                        <div class="text-[10px] font-mono font-bold text-slate-700 dark:text-slate-300 mt-1">${h.fullSlot}</div>
                    </td>
                    <td class="px-4 py-3 text-xs text-slate-600 dark:text-slate-400 leading-tight">${h.info}</td>
                </tr>
            `).join('');

            if(selectedFullSlotsHistory.length > 0) {
                gsap.from(".animate-new-row", { x: -20, opacity: 0, duration: 0.3, background: "#f0fdf4" });
            }
        }

        function renderEmptyState() {
            document.getElementById('slotDisplay').innerHTML = `
                <div class="flex flex-col items-center justify-center py-20 text-slate-400">
                    <span class="material-symbols-outlined text-6xl mb-4 text-slate-200 dark:text-slate-700">dns</span>
                    <p class="text-sm">Waiting for data input...</p>
                </div>`;
            // Reset Preview Grid to Initial State
            document.querySelector('.table-wrapper').innerHTML = `
                <table id="previewTable" class="w-full text-left text-xs">
                    <thead class="bg-slate-50 dark:bg-slate-800/50">
                        <tr id="pHead">
                            <th class="px-4 py-3 font-semibold text-slate-500">Key</th>
                            <th class="px-4 py-3 font-semibold text-slate-500">Value</th>
                        </tr>
                    </thead>
                    <tbody id="pBody">
                        <tr><td colspan="2" class="text-center italic p-6 text-slate-400">Waiting for data paste...</td></tr>
                    </tbody>
                </table>
            `;
            document.getElementById('filterContainer').classList.add('hidden');
        }

        function clearInput() {
            document.getElementById('rawInput').value = "";
            renderEmptyState();
        }

        function clearHistory() {
            if(confirm("Clear all history?")) {
                selectedFullSlotsHistory = [];
                updateHistoryTable();
                if (currentMatches.length > 0) calculateAvailableSlots();
            }
        }
    </script>
</body>
</html>